# æ‰€æœ‰æƒä¸å€Ÿç”¨ + åˆ‡ç‰‡ä¸å­—ç¬¦ä¸²

> è¿™æ˜¯ Rust æœ€æ ¸å¿ƒçš„æ¦‚å¿µï¼Œç†è§£æ‰€æœ‰æƒç³»ç»Ÿæ˜¯æŒæ¡ Rust çš„å…³é”®ã€‚

## æ‰€æœ‰æƒç³»ç»Ÿ

### ä»€ä¹ˆæ˜¯æ‰€æœ‰æƒï¼Ÿ

æ‰€æœ‰æƒï¼ˆOwnershipï¼‰æ˜¯ Rust çš„æ ¸å¿ƒç‰¹æ€§ï¼Œå®ƒè®© Rust èƒ½å¤Ÿåœ¨ä¸ä¾èµ–åƒåœ¾å›æ”¶çš„æƒ…å†µä¸‹ä¿è¯å†…å­˜å®‰å…¨ã€‚

**æ ¸å¿ƒæ€æƒ³**ï¼šæ¯ä¸ªå€¼éƒ½æœ‰ä¸”ä»…æœ‰ä¸€ä¸ª"æ‰€æœ‰è€…"ï¼ˆownerï¼‰ï¼Œå½“æ‰€æœ‰è€…ç¦»å¼€ä½œç”¨åŸŸæ—¶ï¼Œå€¼ä¼šè¢«è‡ªåŠ¨é‡Šæ”¾ã€‚

### æ‰€æœ‰æƒä¸‰å¤§è§„åˆ™

1. **æ¯ä¸ªå€¼éƒ½æœ‰ä¸€ä¸ªæ‰€æœ‰è€…**
2. **åŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªæ‰€æœ‰è€…**
3. **å½“æ‰€æœ‰è€…ç¦»å¼€ä½œç”¨åŸŸæ—¶ï¼Œå€¼ä¼šè¢«é‡Šæ”¾**

```rust
fn main() {
    let s1 = String::from("hello");  // s1 æ˜¯æ‰€æœ‰è€…
    let s2 = s1;                      // æ‰€æœ‰æƒè½¬ç§»ç»™ s2

    // println!("{}", s1);  // é”™è¯¯ï¼s1 ä¸å†æœ‰æ•ˆ
    println!("{}", s2);              // æ­£ç¡®
}  // s2 ç¦»å¼€ä½œç”¨åŸŸï¼ŒString è¢«é‡Šæ”¾
```

### å†…å­˜æ¨¡å‹

Rust ä¸­çš„æ•°æ®ç±»å‹åˆ†ä¸ºä¸¤ç±»ï¼š

| ç±»å‹ | å­˜å‚¨æ–¹å¼ | å¤åˆ¶è¡Œä¸º |
|------|----------|----------|
| **Copy ç±»å‹** | æ ˆä¸Šå­˜å‚¨ | å¤åˆ¶å€¼ï¼ˆæ‹·è´ï¼‰ |
| **Move ç±»å‹** | å †ä¸Šå­˜å‚¨ | ç§»åŠ¨ï¼ˆè½¬ç§»æ‰€æœ‰æƒï¼‰ |

#### Copy ç±»å‹ï¼ˆæ ˆåˆ†é…ï¼‰

ä»¥ä¸‹ç±»å‹å®ç° `Copy` traitï¼Œèµ‹å€¼æ—¶æ˜¯**å¤åˆ¶**è€Œéç§»åŠ¨ï¼š

```rust
// åŸºç¡€ç±»å‹éƒ½æ˜¯ Copy
let x = 5;
let y = x;  // å¤åˆ¶ï¼šx å’Œ y éƒ½æœ‰æ•ˆ
println!("x = {}, y = {}", x, y);  // ä¸¤è€…éƒ½å¯ç”¨

// Copy ç±»å‹åŒ…æ‹¬ï¼š
// - æ‰€æœ‰æ•´æ•°ç±»å‹ï¼ˆi32, u8 ç­‰ï¼‰
// - æ‰€æœ‰æµ®ç‚¹ç±»å‹ï¼ˆf32, f64ï¼‰
// - å¸ƒå°”ç±»å‹ï¼ˆboolï¼‰
// - å­—ç¬¦ç±»å‹ï¼ˆcharï¼‰
// - å…ƒç»„ï¼ˆä»…å½“æ‰€æœ‰å…ƒç´ éƒ½æ˜¯ Copy æ—¶ï¼‰
// - æ•°ç»„ï¼ˆä»…å½“æ‰€æœ‰å…ƒç´ éƒ½æ˜¯ Copy æ—¶ï¼‰
let tuple: (i32, f64) = (1, 2.0);
let tuple2 = tuple;  // Copy
```

#### Move ç±»å‹ï¼ˆå †åˆ†é…ï¼‰

å †ä¸Šåˆ†é…çš„æ•°æ®ï¼ˆå¦‚ `String`ã€`Vec`ï¼‰é»˜è®¤æ˜¯**ç§»åŠ¨**ï¼š

```rust
let s1 = String::from("hello");
let s2 = s1;  // ç§»åŠ¨ï¼šs1 å¤±æ•ˆï¼Œåªæœ‰ s2 æœ‰æ•ˆ

// s1 æ— æ³•å†ä½¿ç”¨
// println!("{}", s1);  // ç¼–è¯‘é”™è¯¯

// ä½†å¯ä»¥é‡æ–°èµ‹å€¼æ¥"å¤ç”¨"å˜é‡å
let s1 = String::from("new string");
```

### ç§»åŠ¨è¯­ä¹‰è¯¦è§£

```rust
fn main() {
    // åˆ›å»º Stringï¼ˆå †åˆ†é…ï¼‰
    let s1 = String::from("hello");

    // ä¼ é€’å‚æ•° - ç§»åŠ¨
    takes_ownership(s1);
    // println!("{}", s1);  // é”™è¯¯ï¼šs1 å·²ç§»åŠ¨

    // è¿”å›å€¼ - ç§»åŠ¨
    let s2 = takes_and_gives_back(String::from("world"));
    println!("{}", s2);  // OK
}

fn takes_ownership(s: String) {
    println!("{}", s);
}  // s ç¦»å¼€ä½œç”¨åŸŸï¼Œè¢«é‡Šæ”¾

fn takes_and_gives_back(s: String) -> String {
    s  // æ‰€æœ‰æƒè¿”å›ç»™è°ƒç”¨è€…
}
```

### å¤åˆ¶è¯­ä¹‰ï¼ˆCloneï¼‰

å¦‚æœç¡®å®éœ€è¦å¤åˆ¶æ•°æ®ï¼ˆè€Œéç§»åŠ¨ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨ `clone()`ï¼š

```rust
let s1 = String::from("hello");
let s2 = s1.clone();  // æ·±æ‹·è´ï¼šå †ä¸Šçš„æ•°æ®ä¹Ÿå¤åˆ¶

println!("s1 = {}, s2 = {}", s1, s2);  // ä¸¤è€…éƒ½æœ‰æ•ˆ

// clone ä¼šæ‰§è¡Œæ·±æ‹·è´ï¼Œæ€§èƒ½å¼€é”€è¾ƒå¤§
// åªæœ‰å¿…è¦æ—¶æ‰ä½¿ç”¨
```

### å€Ÿç”¨ï¼ˆBorrowingï¼‰

å€Ÿç”¨å…è®¸åœ¨ä¸è·å–æ‰€æœ‰æƒçš„æƒ…å†µä¸‹è®¿é—®æ•°æ®ï¼š

```rust
fn main() {
    let s1 = String::from("hello");

    // ä¸å¯å˜å€Ÿç”¨ï¼ˆå¼•ç”¨ï¼‰
    let len = calculate_length(&s1);
    println!("'{}' çš„é•¿åº¦æ˜¯ {}", s1, len);  // s1 ä»ç„¶æœ‰æ•ˆ
}

fn calculate_length(s: &String) -> usize {
    s.len()
}  // s ç¦»å¼€ä½œç”¨åŸŸï¼Œä½†ä¸é‡Šæ”¾ Stringï¼ˆå› ä¸ºåªæ˜¯å€Ÿç”¨ï¼‰
```

---

## å€Ÿç”¨è§„åˆ™ä¸ç”Ÿå‘½å‘¨æœŸ

### å€Ÿç”¨è§„åˆ™

1. **ä»»æ„æ—¶åˆ»**ï¼šåªèƒ½æœ‰ä¸€ä¸ªå¯å˜å¼•ç”¨ **æˆ–** å¤šä¸ªä¸å¯å˜å¼•ç”¨
2. **å¼•ç”¨å¿…é¡»å§‹ç»ˆæœ‰æ•ˆ**ï¼šä¸èƒ½å¼•ç”¨å·²é‡Šæ”¾çš„å†…å­˜ï¼ˆæ‚¬å‚å¼•ç”¨ï¼‰

```rust
fn main() {
    let mut s = String::from("hello");

    // ä¸å¯å˜å¼•ç”¨
    let r1 = &s;
    let r2 = &s;
    // println!("{} å’Œ {}", r1, r2);  // OKï¼šå¤šä¸ªä¸å¯å˜å¼•ç”¨

    // å¯å˜å¼•ç”¨
    let r3 = &mut s;
    r3.push_str(", world");
    println!("{}", r3);  // OK

    // println!("{}", r1);  // é”™è¯¯ï¼šr1 åœ¨ r3 å¯å˜å€Ÿç”¨æœŸé—´ä¸èƒ½ä½¿ç”¨
}
```

### å¯å˜å€Ÿç”¨å†²çªç¤ºä¾‹

```rust
// é”™è¯¯ç¤ºä¾‹ï¼šåŒæ—¶å­˜åœ¨å¯å˜å’Œä¸å¯å˜å¼•ç”¨
let mut s = String::from("hello");
let r1 = &s;      // ä¸å¯å˜å¼•ç”¨
let r2 = &s;      // ä¸å¯å˜å¼•ç”¨
let r3 = &mut s;  // å¯å˜å¼•ç”¨ -> ç¼–è¯‘é”™è¯¯ï¼

println!("{}, {}, and {}", r1, r2, r3);

// ä¿®æ­£ï¼šç¡®ä¿å¼•ç”¨ä¸é‡å 
let mut s = String::from("hello");
let r1 = &s;
let r2 = &s;
println!("{} and {}", r1, r2);
// r1 å’Œ r2 åœ¨æ­¤ä¹‹åä¸å†ä½¿ç”¨

let r3 = &mut s;
r3.push_str(", world");
println!("{}", r3);
```

### æ‚¬å‚å¼•ç”¨ï¼ˆDangling Referenceï¼‰

ç¼–è¯‘å™¨ç¡®ä¿å¼•ç”¨æ°¸è¿œæœ‰æ•ˆï¼Œé˜²æ­¢æ‚¬å‚å¼•ç”¨ï¼š

```rust
// é”™è¯¯ç¤ºä¾‹ï¼šè¿”å›å±€éƒ¨å˜é‡çš„å¼•ç”¨
fn dangling() -> &String {
    let s = String::from("hello");
    &s  // é”™è¯¯ï¼šs åœ¨å‡½æ•°ç»“æŸæ—¶è¢«é‡Šæ”¾
}

// æ­£ç¡®åšæ³•ï¼šç›´æ¥è¿”å›å€¼
fn no_dangling() -> String {
    let s = String::from("hello");
    s  // æ‰€æœ‰æƒè¿”å›ç»™è°ƒç”¨è€…
}
```

---

## åˆ‡ç‰‡ï¼ˆSliceï¼‰

### ä»€ä¹ˆæ˜¯åˆ‡ç‰‡ï¼Ÿ

åˆ‡ç‰‡æ˜¯å¯¹é›†åˆéƒ¨åˆ†å…ƒç´ çš„**å¼•ç”¨**ï¼Œä¸æ‹¥æœ‰æ•°æ®æ‰€æœ‰æƒã€‚

```rust
let s = String::from("hello world");

// å­—ç¬¦ä¸²åˆ‡ç‰‡ &str
let hello = &s[0..5];   // "hello"
let world = &s[6..11]; // "world"

// ç®€å†™è¯­æ³•
let hello = &s[..5];
let world = &s[6..];
let whole = &s[..];
```

### æ•°ç»„åˆ‡ç‰‡

```rust
let arr = [1, 2, 3, 4, 5];

let slice: &[i32] = &arr[1..4];  // [2, 3, 4]

// éå†åˆ‡ç‰‡
for item in slice.iter() {
    println!("{}", item);
}
```

### åˆ‡ç‰‡ä¸æ‰€æœ‰æƒ

åˆ‡ç‰‡æ˜¯å¼•ç”¨ï¼Œä¸å½±å“åŸæ•°æ®çš„æ‰€æœ‰æƒï¼š

```rust
fn main() {
    let arr = vec![1, 2, 3, 4, 5];
    let slice = &arr[1..4];

    println!("åˆ‡ç‰‡: {:?}", slice);
    println!("åŸæ•°ç»„: {:?}", arr);  // arr ä»ç„¶æœ‰æ•ˆ

    // åˆ‡ç‰‡æœ¬èº«åœ¨å‡½æ•°ç»“æŸæ—¶é‡Šæ”¾ï¼Œä½†ä¸å½±å“åŸæ•°ç»„
    process_slice(slice);
    println!("åŸæ•°ç»„: {:?}", arr);  // ä»ç„¶æœ‰æ•ˆ
}

fn process_slice(s: &[i32]) {
    for item in s {
        println!("{}", item);
    }
}
```

---

## å­—ç¬¦ä¸²

### String vs &str

| ç‰¹æ€§ | `String` | `&str` |
|------|----------|--------|
| æ‰€æœ‰æƒ | æ‹¥æœ‰æ•°æ® | å€Ÿç”¨æ•°æ® |
| å¯å˜æ€§ | å¯å˜ | ä¸å¯å˜ |
| å†…å­˜ | å †åˆ†é… | æ ˆ/å †ï¼ˆå–å†³äºæ¥æºï¼‰ |
| å¤§å° | 24 å­—èŠ‚ï¼ˆptr + len + capï¼‰ | 16 å­—èŠ‚ï¼ˆptr + lenï¼‰ |

```rust
// String - æ‹¥æœ‰æ‰€æœ‰æƒçš„åŠ¨æ€å­—ç¬¦ä¸²
let mut s = String::from("hello");
s.push_str(", world");
println!("{}", s);

// &str - å­—ç¬¦ä¸²åˆ‡ç‰‡ï¼ˆå¼•ç”¨ï¼‰
let s: &str = "hello world";  // å­—ç¬¦ä¸²å­—é¢é‡ï¼Œå­˜å‚¨åœ¨äºŒè¿›åˆ¶ä¸­

// String å¯ä»¥è½¬æ¢ä¸º &strï¼ˆå€Ÿç”¨ï¼‰
let s1 = String::from("hello");
let s2: &str = &s1;  // &String ä¼šè‡ªåŠ¨è½¬æ¢ä¸º &str

// &str ä¸èƒ½ç›´æ¥è½¬æ¢ä¸º Stringï¼ˆéœ€è¦å…‹éš†ï¼‰
let s3: String = s2.to_string();
let s4: String = s2.to_owned();
```

### å­—ç¬¦ä¸²å†…éƒ¨è¡¨ç¤º

```rust
// String å†…å­˜å¸ƒå±€
// | ptr (8 bytes) | len (8 bytes) | capacity (8 bytes) |
// å †ä¸Š: [h][e][l][l][o][\0]

// &str å†…å­˜å¸ƒå±€
// | ptr (8 bytes) | len (8 bytes) |
// æŒ‡å‘å·²å­˜åœ¨çš„å­—ç¬¦ä¸²æ•°æ®

let s = String::from("hello");
let slice = &s[1..4];  // "ell"
// slice æŒ‡å‘ s çš„ç¬¬ 1-3 ä¸ªå­—ç¬¦ï¼Œä¸å¤åˆ¶æ•°æ®
```

### å¸¸è§å­—ç¬¦ä¸²æ“ä½œ

```rust
let s = String::from("hello world");

// é•¿åº¦ï¼ˆå­—èŠ‚æ•°ï¼Œéå­—ç¬¦æ•°ï¼‰
println!("å­—èŠ‚æ•°: {}", s.len());           // 11
println!("å­—ç¬¦æ•°: {}", s.chars().count());  // 11

// éå†
for c in s.chars() {
    print!("{} ", c);  // h e l l o ...
}
for b in s.bytes() {
    print!("{} ", b);  // 104 101 108 ...
}

// å­å­—ç¬¦ä¸²ï¼ˆåˆ‡ç‰‡ï¼‰
let hello = &s[0..5];
let world = &s[6..11];

// åˆ†å‰²
let words: Vec<&str> = s.split_whitespace().collect();
// ["hello", "world"]

// è¿æ¥
let s1 = String::from("hello");
let s2 = String::from(" world");
let s3 = s1 + &s2;  // æ³¨æ„ï¼šs1 è¢«ç§»åŠ¨
// println!("{}", s1);  // é”™è¯¯ï¼šs1 å·²ç§»åŠ¨

// æ ¼å¼åŒ–
let s = format!("{} + {} = {}", 1, 2, 3);
println!("{}", s);  // "1 + 2 = 3"
```

### UTF-8 ç¼–ç 

Rust å­—ç¬¦ä¸²æ˜¯ UTF-8 ç¼–ç ï¼š

```rust
let chinese = "ä½ å¥½ä¸–ç•Œ";
let emoji = "ğŸ˜€ğŸ‰";

// å­—èŠ‚é•¿åº¦
println!("å­—èŠ‚: {}", chinese.len());       // 12 (æ¯ä¸ªæ±‰å­— 3 å­—èŠ‚)
println!("å­—ç¬¦: {}", chinese.chars().count()); // 4

// ä¸èƒ½ç”¨ç´¢å¼•ç›´æ¥è®¿é—®å­—ç¬¦
// let c = chinese[0];  // é”™è¯¯ï¼

// æ­£ç¡®æ–¹å¼ï¼šä½¿ç”¨ chars()
let first_char = chinese.chars().nth(0);  // Some('ä½ ')
```

### å­—ç¬¦ä¸²å­—é¢é‡

```rust
// å­—ç¬¦ä¸²å­—é¢é‡ &str
let s = "hello";  // &strï¼Œå­˜å‚¨åœ¨æ ˆä¸Šï¼ˆå®é™…æ˜¯é™æ€åŒºï¼‰

// åŸå§‹å­—ç¬¦ä¸²ï¼ˆä¸è½¬ä¹‰ï¼‰
let raw = r#"C:\Users\test"#;
let html = r#"<div class="test">"#;

// å¸¦åŸå§‹å­—ç¬¦çš„å­—ç¬¦ä¸²
let multi_line = r#"
    ç¬¬ä¸€è¡Œ
    ç¬¬äºŒè¡Œ
"#;

// è¿æ¥å­—ç¬¦ä¸²å­—é¢é‡ï¼ˆç¼–è¯‘æ—¶åˆå¹¶ï¼‰
let s = "hello " "world";  // ç­‰åŒäº "hello world"
```

---

## å°ç»“

æœ¬ç« æˆ‘ä»¬æ·±å…¥å­¦ä¹ äº† Rust æœ€æ ¸å¿ƒçš„æ¦‚å¿µï¼š

### æ‰€æœ‰æƒç³»ç»Ÿ
1. **ä¸‰å¤§è§„åˆ™**ï¼šæ¯ä¸ªå€¼æœ‰æ‰€æœ‰è€…ã€å”¯ä¸€æ‰€æœ‰è€…ã€ç¦»å¼€ä½œç”¨åŸŸé‡Šæ”¾
2. **ç§»åŠ¨è¯­ä¹‰**ï¼šå †ä¸Šæ•°æ®é»˜è®¤ç§»åŠ¨ï¼ˆStringã€Vec ç­‰ï¼‰
3. **å¤åˆ¶è¯­ä¹‰**ï¼šæ ˆä¸Šæ•°æ®å®ç° Copy traitï¼Œå¯å…‹éš†

### å€Ÿç”¨ç³»ç»Ÿ
1. **å€Ÿç”¨è§„åˆ™**ï¼šå¯å˜å¼•ç”¨ä¸ä¸å¯å˜å¼•ç”¨ä¸èƒ½åŒæ—¶å­˜åœ¨
2. **æ‚¬å‚å¼•ç”¨**ï¼šç¼–è¯‘å™¨é˜²æ­¢è¿”å›æ— æ•ˆå¼•ç”¨

### åˆ‡ç‰‡ä¸å­—ç¬¦ä¸²
1. **åˆ‡ç‰‡**ï¼š`&[T]` å’Œ `&str` æ˜¯å¯¹æ•°æ®çš„å¼•ç”¨
2. **String vs &str**ï¼šæ‹¥æœ‰ vs å€Ÿç”¨
3. **UTF-8**ï¼šRust å­—ç¬¦ä¸²ä½¿ç”¨ UTF-8 ç¼–ç 

> ğŸ’¡ **æç¤º**ï¼šæ‰€æœ‰æƒç³»ç»Ÿæ˜¯ Rust å­¦ä¹ æ›²çº¿è¾ƒé™¡çš„éƒ¨åˆ†ï¼Œå»ºè®®å¤šå†™ä»£ç ç»ƒä¹ ï¼Œä½“ä¼š"æ‰€æœ‰æƒçš„è½¬ç§»"å’Œ"å€Ÿç”¨"çš„æ¦‚å¿µã€‚

ä¸‹ä¸€ç« èŠ‚æˆ‘ä»¬å°†å­¦ä¹ ç»“æ„ä½“ã€æšä¸¾å’Œé”™è¯¯å¤„ç†ã€‚
